#!/usr/bin/env bash

set -euo pipefail

own() {
    sudo mkdir -p /usr/local/"$1"
    sudo chown -R "$(whoami)":admin /usr/local/"$1"
}

install_homebrew() {
    # https://github.com/Homebrew/brew/issues/3228
    own homebrew
    own var/homebrew
    if [[ ! -e /usr/local/homebrew ]]; then
        echo "Installing homebrew..."
        curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh
    fi
}

main() {
    install_homebrew
    echo "Installing packages..."
    local -r DIR="$(pwd)/$(dirname "${BASH_SOURCE[0]}")/../.."
    local -r FILE=$(python -c "import os; print(os.path.realpath('$DIR/Brewfile'))")
    brew bundle install --file "$FILE"
}

main
